{% extends "base.html" %}

{% block title %}Report Rimborso Missione #{{ trasferta.id }}{% endblock %}

{% block content %}
<div class="container mt-4 mb-5 printable-area">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <div class="card shadow">
                <div class="card-header bg-success text-white text-center">
                    <h4 class="mb-0">REPORT PER RIMBORSO SPESE E LIQUIDAZIONE</h4>
                    <p class="mb-0">Missione ID: <strong>{{ trasferta.id }}</strong> - Richiedente: {{ trasferta.richiedente.nome }} {{ trasferta.richiedente.cognome }}</p>
                </div>
                <div class="card-body">

                    <h5 class="mt-3 mb-3 text-success border-bottom pb-1">Dati Essenziali di Rendicontazione</h5>
                    
                    <table class="table table-bordered table-sm">
                        <tr><td><strong>Data Missione:</strong></td><td>{{ trasferta.giorno_missione.strftime('%d/%m/%Y') }}</td></tr>
                        <tr><td><strong>Orario Effettivo Missione:</strong></td>
                            <td>Dalle {{ trasferta.ora_inizio_effettiva.strftime('%H:%M') }} alle {{ trasferta.ora_fine_effettiva.strftime('%H:%M') }}</td>
                        </tr>
                        <tr><td><strong>Chilometri Percorsi (Km):</strong></td><td>{{ trasferta.km_percorsi or 'N/D' }} Km</td></tr>
                    </table>

                    <h5 class="mt-4 mb-3 text-success border-bottom pb-1">Riepilogo Spese e Totali</h5>
                    {% if trasferta.spese %}
                    <table class="table table-bordered table-striped table-sm">
                        <thead class="bg-light">
                            <tr>
                                <th>Categoria</th>
                                <th>Data Spesa</th>
                                <th>Descrizione</th>
                                <th class="text-end">Importo (€)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set totale_rimborso = [0] %}
                            {% for spesa in trasferta.spese %}
                            {% set _ = totale_rimborso.append(totale_rimborso.pop() + spesa.importo) %}
                            <tr>
                                <td>{{ spesa.categoria }}</td>
                                <td>{{ spesa.data_spesa.strftime('%d/%m/%Y') }}</td>
                                <td>{{ spesa.descrizione or '—' }}</td>
                                <td class="text-end"><strong>{{ spesa.importo | round(2) }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">TOTALE RIMBORSO RICHIESTO:</th>
                                <th class="text-end text-danger">
                                    <td><strong class="text-danger">€ {{ trasferta.totale_rimborso | round(2) }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    {% else %}
                        <div class="alert alert-info">Nessuna spesa da rimborsare è stata registrata.</div>
                    {% endif %}
                   
                    
                    <h5 class="mt-4 mb-3 text-success border-bottom pb-1">Stato Liquidazione Finale</h5>
                    <table class="table table-bordered table-sm">
                        <tr>
                            <td style="width: 30%;"><strong>Stato:</strong></td>
                            <td><span class="badge bg-success">{{ trasferta.stato_post_missione }}</span></td>
                        </tr>
                        <tr>
                            <td><strong>Totale Spese da Rimborsare:</strong></td>
                            <td>**€ {{ trasferta.totale_rimborso | format_currency }}** (CALCOLO DA IMPLEMENTARE)</td>
                        </tr>
                        <tr>
                            <td>**Approvato da:**</td>
                            <td>{{ trasferta.approvatore_post.nome }} {{ trasferta.approvatore_post.cognome }} (in data {{ trasferta.data_approvazione_post.strftime('%d/%m/%Y') }})</td>
                        </tr>
                    </table>

                    <div class="mt-4 text-center">
                        <button class="btn btn-secondary btn-lg d-print-none" onclick="window.print()">Stampa Documento per Contabilità</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}