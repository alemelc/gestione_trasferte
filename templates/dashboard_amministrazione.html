{% extends "base.html" %}

{% block title %}Dashboard Amministrazione{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ðŸ’° Approvazioni Finali di Rimborso in Sospeso</h2>

    {# Messaggi Flash (importante per vedere il successo dell'approvazione finale) #}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    {% if trasferte_da_approvare %}
    <p>Di seguito le missioni approvate dal dirigente, in attesa di liquidazione e chiusura finale.</p>

    <table class="table table-striped table-hover mt-4 align-middle">
        <thead class="table-dark">
            <tr>
                <th style="width: 5%;">ID</th>
                <th style="width: 15%;">Richiedente</th>
                <th style="width: 8%;">Data</th>
                <th style="width: 12%;">Destinazione</th>
                <th style="width: 12%;">Motivo</th>
                <th style="width: 8%;">Spese Totali</th>
                <th style="width: 8%;">Stato</th>
                <th style="width: 12%;">Azioni</th>
                <th class="text-center" style="width: 10%;">Gestito Presenze</th>
                <th class="text-center" style="width: 10%;">NBP</th>
            </tr>
            <!-- Riga Filtri -->
            <tr class="filters">
                <th><input type="text" class="form-control form-control-sm column-filter" data-col="0" placeholder="ID">
                </th>
                <th><input type="text" class="form-control form-control-sm column-filter" data-col="1"
                        placeholder="Dipendente"></th>
                <th><input type="text" class="form-control form-control-sm column-filter" data-col="2"
                        placeholder="Data"></th>
                <th><input type="text" class="form-control form-control-sm column-filter" data-col="3"
                        placeholder="Destinazione"></th>
                <th><input type="text" class="form-control form-control-sm column-filter" data-col="4"
                        placeholder="Motivo"></th>
                <th><input type="text" class="form-control form-control-sm column-filter" data-col="5"
                        placeholder="Importo"></th>
                <th><input type="text" class="form-control form-control-sm column-filter" data-col="6"
                        placeholder="Stato"></th>
                <th></th> <!-- Azioni -->
                <th></th> <!-- Gestito -->
                <th></th> <!-- NBP -->
            </tr>
        </thead>
        <tbody>
            {% for trasferta in trasferte_da_approvare %}
            <tr>
                <td>{{ trasferta.id }}</td>
                <td>{{ trasferta.richiedente.nome }} {{ trasferta.richiedente.cognome }}</td>
                <td>{{ trasferta.giorno_missione.strftime('%d/%m/%Y') }}</td>
                <td>{{ trasferta.missione_presso }}</td>
                <td>{{ trasferta.motivo_missione }}</td>
                <td>{{ "%.2f"|format(trasferta.totale_spese) }} â‚¬</td>
                <td>
                    <span
                        class="badge {% if trasferta.stato_post_missione == 'In attesa' %}bg-warning{% elif trasferta.stato_post_missione == 'Da rimborsare' %}bg-info text-dark{% elif trasferta.stato_post_missione == 'Rimborso Concesso' %}bg-success{% elif trasferta.stato_post_missione == 'Rimborso negato' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ trasferta.stato_approvazione_finale if trasferta.stato_approvazione_finale else
                        trasferta.stato_post_missione }}
                    </span>
                </td>
                <td>
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('dettagli_trasferta', trasferta_id=trasferta.id) }}"
                            class="btn btn-info btn-sm">Dettagli</a>

                        <form method="POST" action="{{ url_for('approva_rimborso_finale', trasferta_id=trasferta.id) }}"
                            style="display:inline;">
                            <button type="submit" class="btn btn-success btn-sm"
                                onclick="return confirm('Confermi l\'approvazione e la liquidazione del rimborso?');">
                                Conferma pagamento
                            </button>
                        </form>
                    </div>
                </td>
                <td class="text-center">
                    <input class="form-check-input" type="checkbox" onclick="return false;" style="opacity: 1;" {% if
                        trasferta.gestito_presenze %}checked{% endif %}>
                </td>
                <td class="text-center">
                    <input class="form-check-input" type="checkbox" onclick="return false;" style="opacity: 1;" {% if
                        trasferta.nbp %}checked{% endif %}>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% else %}
    <div class="alert alert-success" role="alert">
        Non ci sono richieste di rimborso in attesa di approvazione finanziaria.
    </div>
    {% endif %}

    <hr class="my-5">

    <h2>ðŸ“œ Storico Approvazioni</h2>
    <p>Elenco delle missioni giÃ  rimborsate/processate dall'amministrazione.</p>

    <table class="table table-striped table-hover mt-4 align-middle">
        <thead class="table-dark">
            <tr>
                <th style="width: 5%;">ID</th>
                <th style="width: 15%;">Richiedente</th>
                <th style="width: 8%;">Data</th>
                <th style="width: 12%;">Destinazione</th>
                <th style="width: 12%;">Motivo</th>
                <th style="width: 8%;">Spese Totali</th>
                <th style="width: 8%;">Stato</th>
                <th style="width: 12%;">Azioni</th>
                <th class="text-center" style="width: 10%;">Gestito Presenze</th>
                <th class="text-center" style="width: 10%;">NBP</th>
            </tr>
        </thead>
        <tbody>
            {% for t in trasferte_storico %}
            <tr>
                <td>{{ t.id }}</td>
                <td>{{ t.richiedente.nome }} {{ t.richiedente.cognome }}</td>
                <td>{{ t.giorno_missione.strftime('%d/%m/%Y') }}</td>
                <td>{{ t.missione_presso }}</td>
                <td>{{ t.motivo_missione }}</td>
                <td>{{ "%.2f"|format(t.totale_spese) }} â‚¬</td>
                <td>
                    <span class="badge bg-success">
                        {{ t.stato_approvazione_finale }}
                    </span>
                </td>
                <td>
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('dettagli_trasferta', trasferta_id=t.id) }}"
                            class="btn btn-secondary btn-sm">Dettagli</a>
                    </div>
                </td>
                <td class="text-center">
                    <input class="form-check-input" type="checkbox" onclick="return false;" style="opacity: 1;" {% if
                        t.gestito_presenze %}checked{% endif %}>
                </td>
                <td class="text-center">
                    <input class="form-check-input" type="checkbox" onclick="return false;" style="opacity: 1;" {% if
                        t.nbp %}checked{% endif %}>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

{% block custom_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Scope filters to the first table only (Pending Approvals)
        // Adjust selectors to target specific table if needed, 
        // but current .column-filter is only present in the first table's header.
        // However, rows variable selects ALL 'tbody tr', which includes the second table!
        // We must fix this to avoid filtering the history table when typing in the pending table.

        const firstTable = document.querySelector('table'); // Assumes pending is the first table
        if (!firstTable) return;

        const filters = firstTable.querySelectorAll('.column-filter');
        const rows = firstTable.querySelectorAll('tbody tr');

        function filterTable() {
            const activeFilters = {};
            filters.forEach(filter => {
                if (filter.value.toLowerCase().trim() !== '') {
                    activeFilters[filter.dataset.col] = filter.value.toLowerCase().trim();
                }
            });

            rows.forEach(row => {
                const cells = row.cells;
                let shouldShow = true;

                for (const colIndex in activeFilters) {
                    if (cells[colIndex]) {
                        const cellText = cells[colIndex].textContent.toLowerCase();
                        if (!cellText.includes(activeFilters[colIndex])) {
                            shouldShow = false;
                            break;
                        }
                    }
                }

                row.style.display = shouldShow ? '' : 'none';
            });
        }

        filters.forEach(filter => {
            filter.addEventListener('keyup', filterTable);
            filter.addEventListener('change', filterTable);
        });
    });
</script>
{% endblock %}
{% endblock %}