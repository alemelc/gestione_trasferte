{% extends "base.html" %}

{% block title %}Dashboard Presenze{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>Dashboard Presenze - Storico Trasferte</h2>
            <p class="text-muted">Visualizzazione di tutte le trasferte per la gestione presenze.</p>
        </div>
        <a href="{{ url_for('export_csv_presenze') }}" class="btn btn-success">
            <i class="fas fa-file-csv"></i> Esporta CSV
        </a>
    </div>

    <div class="table-responsive mt-3">
        <table class="table table-striped table-bordered table-hover align-middle">
            <thead class="table-dark">
                <tr>
                <tr>
                <tr>
                    <th>ID</th>
                    <th>Dipendente</th>
                    <th>Data</th>
                    <th style="width: 15%;">Destinazione</th>
                    <th style="width: 10%;">Motivo</th>
                    <th style="width: 10%;">Spese (€)</th>
                    <th style="width: 10%;">Extra Orario</th>
                    <th style="width: 10%;">Pasto</th>
                    <th>Stato Finale</th>
                    <th>Azioni</th>
                    <th class="text-center" style="width: 100px;">Gestito da Presenze</th>
                    <th class="text-center" style="width: 80px;">NBP</th>
                </tr>
                <!-- Riga Filtri -->
                <tr class="filters">
                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="0"
                            placeholder="Filtra ID"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="1"
                            placeholder="Filtra Dip."></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="2"
                            placeholder="Filtra Data"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="3"
                            placeholder="Filtra Dest."></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="4"
                            placeholder="Filtra Motivo"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="5"
                            placeholder="Filtra Spese"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="6"
                            placeholder="Filtra Extra"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="7"
                            placeholder="Filtra Pasto"></th>
                    <th><input type="text" class="form-control form-control-sm column-filter" data-col="8"
                            placeholder="Filtra Stato"></th>
                    <th></th> <!-- No filter for Azioni -->
                    <th></th> <!-- No filter for Checkbox -->
                    <th></th> <!-- No filter for Checkbox -->
                </tr>
            </thead>
            <tbody>
                {% for t in trasferte %}
                <tr data-id="{{ t.id }}">
                    <td>{{ t.id }}</td>
                    <td>{{ t.richiedente.nome }} {{ t.richiedente.cognome }}</td>
                    <td>{{ t.giorno_missione.strftime('%d/%m/%Y') }}</td>
                    <td>{{ t.missione_presso }}</td>
                    <td>{{ t.motivo_missione | default('-', true) }}</td>
                    <td>{{ "%.2f"|format(t.totale_spese) }}</td>

                    {# Colonna Extra Orario #}
                    <td>{{ t.extra_orario | default('-', true) }}</td>

                    {# Colonna Pasto #}
                    <td>{{ t.richiesta_pausa_pranzo | default('-', true) }}</td>

                    <td>
                        <span
                            class="badge {% if t.stato_post_missione in ['Rimborso Concesso', 'Conclusa', 'Rimborsata'] %}bg-success{% elif t.stato_post_missione in ['Rimborso negato', 'Rifiutata', 'Rifiutata post', 'Rifiutato Post'] %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ t.stato_post_missione }}
                        </span>
                    </td>

                    <td>
                        <!-- Pulsante Dettagli: apre sempre il modale completo (rendiconto) -->
                        <button type="button" class="btn btn-outline-dark btn-sm open-approvazione-modal"
                            data-id="{{ t.id }}" data-fase="rendiconto" data-readonly="true">
                            Dettagli
                        </button>
                    </td>

                    {# Checkbox Gestito Presenze #}
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input presenze-check" data-id="{{ t.id }}"
                            data-field="gestito_presenze" {% if t.gestito_presenze %}checked{% endif %}>
                    </td>

                    {# Checkbox NBP #}
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input presenze-check" data-id="{{ t.id }}"
                            data-field="nbp" {% if t.nbp %}checked{% endif %}>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# MODALE UNIFICATO #}
<div class="modal fade" id="approvazioneModal" tabindex="-1" aria-labelledby="approvazioneModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approvazioneModalLabel">Dettagli Missione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modale-body-content">
                <!-- Contenuto caricato via AJAX -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 1. Gestione click sui checkbox
        const checkboxes = document.querySelectorAll('.presenze-check');

        checkboxes.forEach(chk => {
            chk.addEventListener('change', function () {
                const trasfertaId = this.dataset.id;
                const field = this.dataset.field;
                const isChecked = this.checked;

                // Chiamata AJAX per aggiornare lo stato
                fetch('/api/update_presenze_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
                    },
                    body: JSON.stringify({
                        trasferta_id: trasfertaId,
                        field: field,
                        value: isChecked
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            // Se la risposta non è 200-299, lancia un errore con lo status
                            return response.text().then(text => {
                                throw new Error(`Server error: ${response.status} - ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            console.log('Update riuscito');
                        } else {
                            alert('Errore nell\'aggiornamento: ' + (data.error || 'Server error'));
                            this.checked = !isChecked; // Revert
                        }
                    })
                    .catch(err => {
                        console.error('Fetch error:', err);
                        alert('Errore di comunicazione con il server. Vedi console per dettagli.');
                        this.checked = !isChecked; // Revert
                    });
            });
        });

        // 2. Gestione Modale Dettagli
        document.querySelectorAll('.open-approvazione-modal').forEach(button => {
            button.addEventListener('click', function () {
                const trasfertaId = this.dataset.id;
                const fase = this.dataset.fase;
                const isReadonly = this.dataset.readonly === 'true';

                const contentDiv = document.getElementById('modale-body-content');
                const modalTitle = document.getElementById('approvazioneModalLabel');
                const modalEl = document.getElementById('approvazioneModal');

                if (!modalEl) {
                    alert("Errore interno: Modale non trovato.");
                    return;
                }

                // Check bootstrap
                if (typeof bootstrap === 'undefined') {
                    alert("Errore: Libreria Bootstrap non caricata.");
                    return;
                }

                const title = {
                    'pre': 'Dettagli Pre-Missione',
                    'rendiconto': 'Dettagli Rendiconto'
                }[fase] || 'Dettagli';

                modalTitle.textContent = title + (isReadonly ? ' (Sola Lettura)' : '');
                contentDiv.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"></div><br>Caricamento dati...</div>';

                // Apri modale
                try {
                    var modal = new bootstrap.Modal(modalEl);
                    modal.show();
                } catch (e) {
                    console.error(e);
                    alert("Impossibile aprire il modale: " + e.message);
                    return;
                }

                let url = `/get_modale_content/${trasfertaId}/${fase}`;
                if (isReadonly) {
                    url += '?readonly=true';
                }

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Errore HTTP ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        contentDiv.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        contentDiv.innerHTML = `<p class="text-danger">Errore: ${error.message}</p>`;
                    });
            });
        });

        // 3. Logic Filtri Tabella
        const filters = document.querySelectorAll('.column-filter');
        const tableBody = document.querySelector('table tbody'); // Selettore più specifico
        const rows = tableBody ? tableBody.querySelectorAll('tr') : [];

        function filterTable() {
            const activeFilters = {};

            // Raccogliamo i valori
            filters.forEach(f => {
                const val = f.value.toLowerCase().trim();
                if (val !== '') {
                    activeFilters[f.dataset.col] = val;
                }
            });

            // Applichiamo i filtri
            rows.forEach(row => {
                let shouldShow = true;
                const cells = row.cells;

                for (const colIndex in activeFilters) {
                    // Nota: colIndex è stringa, ma va bene per l'accesso array
                    if (cells[colIndex]) {
                        const cellText = cells[colIndex].textContent.toLowerCase();
                        const filterVal = activeFilters[colIndex];

                        // Check contains
                        if (!cellText.includes(filterVal)) {
                            shouldShow = false;
                            break;
                        }
                    }
                }
                row.style.display = shouldShow ? '' : 'none';
            });
        }

        filters.forEach(filter => {
            filter.addEventListener('keyup', filterTable);
            filter.addEventListener('input', filterTable); // input gestisce anche il clear (x) type="search" e cut/paste
        });
    });
</script>
{% endblock %}