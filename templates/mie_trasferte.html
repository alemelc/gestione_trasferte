{% extends "base.html" %}

{% block title %}Mie Trasferte e Richieste{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Le Tue Trasferte e Richieste di Approvazione</h2>

    {# Messaggi Flash #}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    {% if trasferte %}
    <table class="table table-striped table-hover mt-4">
        <thead class="thead-dark">
            <tr>
                <th>ID</th>
                <th>Richiedente</th>
                <th>Data Missione</th>
                <th>Destinazione</th>
                <th>Stato Pre-Missione</th>
                <th>Stato Post-Missione</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody>
            {% for trasferta in trasferte %}
            <tr>
                <td>{{ trasferta.id }}</td>
                {# Nome e cognome del richiedente #}
                <td>{{ trasferta.richiedente.nome }} {{ trasferta.richiedente.cognome }}</td>
                <td>{{ trasferta.giorno_missione.strftime('%d/%m/%Y') }}</td>
                <td>{{ trasferta.missione_presso }}</td>

                {# STATO PRE-MISSIONE #}
                <td>
                    {% if trasferta.stato_pre_missione == 'In attesa' %}
                    <span class="badge bg-warning text-dark">{{ trasferta.stato_pre_missione }}</span>
                    {% elif trasferta.stato_pre_missione == 'Approvata' %}
                    <span class="badge bg-success">{{ trasferta.stato_pre_missione }}</span>
                    {% else %}
                    <span class="badge bg-danger">{{ trasferta.stato_pre_missione }}</span>
                    {% endif %}

                    <!-- Pulsante Dettagli Pre-Missione -->
                    <button type="button" class="btn btn-outline-dark btn-sm ms-2 open-approvazione-modal"
                        data-id="{{ trasferta.id }}" data-fase="pre" data-readonly="true" title="Visualizza Dettagli">
                        Dettagli
                    </button>
                </td>

                {# STATO POST-MISSIONE #}
                <td>
                    {% if trasferta.stato_post_missione == 'In attesa' %}
                    <span class="badge bg-warning text-dark">{{ trasferta.stato_post_missione }}</span>
                    {% elif trasferta.stato_post_missione == 'Da rimborsare' %}
                    <span class="badge bg-success">Approvato</span>
                    {% elif trasferta.stato_post_missione == 'Rimborso Concesso' %}
                    <span class="badge bg-success">Rimborsato</span>
                    {% elif trasferta.stato_post_missione == 'Rimborso negato' %}
                    <span class="badge bg-danger">Negato</span>
                    {% else %}
                    <span class="badge bg-info">{{ trasferta.stato_post_missione }}</span>
                    {% endif %}

                    <!-- Pulsante Dettagli Post-Missione (Solo se c'è qualcosa da vedere) -->
                    {% if trasferta.stato_post_missione != 'N/A' %}
                    <button type="button" class="btn btn-outline-dark btn-sm ms-2 open-approvazione-modal"
                        data-id="{{ trasferta.id }}" data-fase="rendiconto" data-readonly="true"
                        title="Visualizza Dettagli">
                        Dettagli
                    </button>
                    {% endif %}
                </td>

                <td>

                    {# 1. AZIONI DIRIGENTE/DELEGATO #}
                    {# Condizione principale: L'utente è il richiedente (Dirigente che viaggia) OPPURE è un approvatore
                    autorizzato (Dirigente assegnato o Delegato). #}

                    {% set is_action_needed_by_approver = is_authorized_approver(trasferta) and
                    (trasferta.stato_pre_missione == 'In attesa' or trasferta.stato_post_missione == 'In attesa') %}

                    {% if trasferta.id_dipendente == current_user.id or is_action_needed_by_approver %}

                    {# A) AZIONI PER IL RICHIEDENTE (Dipendente/Dirigente che compila/rivedrà) #}
                    {% if trasferta.id_dipendente == current_user.id %}

                    {# PRIORITY 1: Rendicontazione #}
                    {% if trasferta.stato_pre_missione == 'Approvata' and trasferta.stato_post_missione in ['N/A',
                    'Rifiutato Post'] %}
                    <a href="{{ url_for('rendiconta_trasferta', trasferta_id=trasferta.id) }}"
                        class="btn btn-primary btn-sm">Rendiconta</a>

                    {# GESTIONE SPESE #}
                    {% elif trasferta.stato_post_missione == 'Compilata' %}
                    <a href="{{ url_for('gestisci_spese', trasferta_id=trasferta.id) }}"
                        class="btn btn-warning btn-sm mb-1">
                        <i class="fas fa-euro-sign"></i> Gestisci Spese
                    </a>

                    {# Richiesta di Rimborso IN CORSO #}
                    {% elif trasferta.stato_post_missione == 'Rimborso Richiesto' %}
                    <span class="badge bg-info">In attesa Approv. Finanziaria</span>
                    {% endif %}

                    {# Pulsante Stampa Report (INDIPENDENTE) #}
                    {% if trasferta.stato_post_missione == 'Pronto per Rimborso' or trasferta.stato_post_missione in
                    ['Rimborso Concesso', 'Rimborso Negato', 'Compilata'] %}
                    <a href="{{ url_for('report_trasferta', trasferta_id=trasferta.id) }}" class="btn btn-info btn-sm"
                        target="_blank">Stampa Report</a>
                    {% endif %}

                    {# B) AZIONI PER L'APPROVATORE AUTORIZZATO (Dirigente/Delegato che non è il richiedente) #}
                    {% elif is_action_needed_by_approver %}

                    {% if trasferta.stato_pre_missione == 'In attesa' %}
                    <button type="button" class="btn btn-warning btn-sm mb-1 open-approvazione-modal"
                        data-id="{{ trasferta.id }}" data-fase="pre">
                        Dettagli & Approv. Pre
                    </button>

                    {% elif trasferta.stato_post_missione == 'In attesa' %}
                    <button type="button" class="btn btn-warning btn-sm mb-1 open-approvazione-modal"
                        data-id="{{ trasferta.id }}" data-fase="rimborso">
                        Dettagli & Approv. Post
                    </button>

                    {# APPROVAZIONE RIMBORSO FINANZIARIO - (DA INSERIRE PIÙ AVANTI) #}
                    {% elif trasferta.stato_post_missione == 'Pronto per Rimborso' and current_user.ruolo ==
                    'Amministrazione' %}
                    <form method="POST" action="{{ url_for('approva_rimborso_finale', trasferta_id=trasferta.id) }}"
                        style="display:inline;">
                        <button type="submit" class="btn btn-success btn-sm"
                            onclick="return confirm('Confermi l\'approvazione e la liquidazione del rimborso per questa missione? ATTENZIONE: Questa azione è irreversibile.');">
                            Approva Rimborso Finale
                        </button>
                    </form>

                    {# Opzionale: Aggiungere un Rifiuto Finanziario se necessario #}
                    {# Esempio:
                    <button type="button" class="btn btn-danger btn-sm mb-1 open-approvazione-modal"
                        data-id="{{ trasferta.id }}" data-fase="rifiuto_finale">
                        Rifiuta Rimborso
                    </button>
                    #}

                    {% else %}
                    Nessuna azione di approvazione in sospeso
                    {% endif %}

                    {% endif %}

                    {# 2. AZIONI DIPENDENTE NORMALE (Non è l'approvatore di questa missione) #}
                    {# Il tuo vecchio blocco 2 non serve più perché è stato assorbito nel nuovo Blocco 1 (A) #}

                    {# 3. ALTRI UTENTI #}
                    {% else %}
                    Nessuna azione
                    {% endif %}
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info mt-4" role="alert">
        Non hai trasferte richieste o richieste di approvazione pendenti.
    </div>
    {% endif %}

    <div class="mt-4">
        <a href="{{ url_for('nuova_trasferta') }}" class="btn btn-primary">Richiedi Nuova Trasferta</a>
    </div>

</div>


<div class="container mt-4">
</div>
{# ====================================================================== #}
{# 1. MODALE BOOTSTRAP UNIFICATO #}
{# Idealmente questo blocco andrebbe in un 'block modals' nel base.html, ma per consistenza lo lascio qui. #}
{# ====================================================================== #}
<div class="modal fade" id="approvazioneModal" tabindex="-1" aria-labelledby="approvazioneModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approvazioneModalLabel">Dettagli Approvazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modale-body-content">
            </div>
        </div>
    </div>
</div>

{% endblock %}





{# ====================================================================== #}
{# 2. SCRIPT JAVASCRIPT #}
{# Assumendo che il blocco per gli script si chiami 'custom_scripts' #}
{# ====================================================================== #}






<!--
{% block custom_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestore per tutti i pulsanti che aprono il modale
    document.querySelectorAll('.open-approvazione-modal').forEach(button => {
        button.addEventListener('click', function() {
            const trasfertaId = this.dataset.id;
            const fase = this.dataset.fase;
            const contentDiv = document.getElementById('modale-body-content'); 
            const modalTitle = document.getElementById('approvazioneModalLabel');
            
            const isReadonly = this.dataset.readonly === 'true'; // Legge il data attribute
            
            // 1. Aggiorna il titolo del modale in base alla fase
            const title = {
                'pre': 'Dettagli e Approvazione Pre-Missione',
                'rendiconto': 'Dettagli e Approvazione Rendiconto (Fase Post)',
                'rimborso': 'Approvazione Rendiconto Finale'
            }[fase];
            modalTitle.textContent = title + (isReadonly ? ' (Sola Lettura)' : '');

            contentDiv.innerHTML = '<p class="text-info">Caricamento in corso...</p>';
            
            // 2. Chiama la rotta Flask (es: /get_modale_content/5/rimborso?readonly=true)
            let url = `/get_modale_content/${trasfertaId}/${fase}`;
            if (isReadonly) {
                url += '?readonly=true';
            }

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Errore HTTP ${response.status}: Impossibile caricare il contenuto.`);
                    }
                    return response.text();
                })
                .then(html => {
                    // 3. Inserisce il frammento HTML (il contenuto del modale)
                    contentDiv.innerHTML = html;
                    
                    // 4. Mostra il modale
                    var modal = new bootstrap.Modal(document.getElementById('approvazioneModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    contentDiv.innerHTML = `<p class="text-danger">Errore durante il caricamento: ${error.message}</p>`;
                });
        });
    });
}); 
</script>
{% endblock %}
-->