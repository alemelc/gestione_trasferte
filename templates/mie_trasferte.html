{% extends "base.html" %}

{% block title %}Mie Trasferte e Richieste{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Le Tue Trasferte e Richieste di Approvazione</h2>

    {# Messaggi Flash #}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    {% if trasferte %}
    <table class="table table-striped table-hover mt-4">
        <thead class="thead-dark">
            <tr>
                <th>ID</th>
                <th>Richiedente</th>
                <th>Data Missione</th>
                <th>Destinazione</th>
                <th>Stato Pre-Missione</th>
                <th>Stato Post-Missione</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody>
            {% for trasferta in trasferte %}
            <tr>
                <td>{{ trasferta.id }}</td>
                {# ✅ CORREZIONE NOME + COGNOME CON SPAZIO #}
                <td>{{ trasferta.richiedente.nome }} {{ trasferta.richiedente.cognome }}</td>
                <td>{{ trasferta.giorno_missione.strftime('%d/%m/%Y') }}</td>
                <td>{{ trasferta.missione_presso }}</td>

                {# STATO PRE-MISSIONE #}
                <td>
                    {% if trasferta.stato_pre_missione == 'In attesa' %}
                    <span class="badge bg-warning text-dark">{{ trasferta.stato_pre_missione }}</span>
                    {% elif trasferta.stato_pre_missione == 'Approvata' %}
                    <span class="badge bg-success">{{ trasferta.stato_pre_missione }}</span>
                    {% else %}
                    <span class="badge bg-danger">{{ trasferta.stato_pre_missione }}</span>
                    {% endif %}
                </td>

                {# STATO POST-MISSIONE #}
                <td>
                    {% if trasferta.stato_post_missione == 'In attesa' %}
                    <span class="badge bg-warning text-dark">{{ trasferta.stato_post_missione }}</span>
                    {% elif trasferta.stato_post_missione == 'Da rimborsare' %}
                    <span class="badge bg-success">Approvato</span>
                    {% elif trasferta.stato_post_missione == 'Rimborso Concesso' %}
                    <span class="badge bg-success">Rimborsato</span>
                    {% elif trasferta.stato_post_missione == 'Rimborso negato' %}
                    <span class="badge bg-danger">Negato</span>
                    {% else %}
                    <span class="badge bg-info">{{ trasferta.stato_post_missione }}</span>
                    {% endif %}
                </td>

                <td>
                    {# 1. AZIONI DIRIGENTE/DELEGATO (Se è l'approvatore diretto O è un delegato attivo) #}
                    {% if trasferta.id_dirigente == current_user.id or current_user.id in ids_approvatori_autorizzati %}

                    {# PRIORITÀ 1: Se il Dirigente/Approvatore è anche il richiedente e può rendicontare #}
                    {% if trasferta.id_dipendente == current_user.id and trasferta.stato_pre_missione == 'Approvata' and
                    trasferta.stato_post_missione == 'N/A' %}
                    <a href="{{ url_for('rendiconta_trasferta', trasferta_id=trasferta.id) }}"
                        class="btn btn-primary btn-sm">Rendiconta (Tua Missione)</a>

                    {# ALTRIMENTI: Mostra le azioni di Approvazione per gli altri dipendenti #}
                    {% else %}    

                            {# Azioni annidate di Approvazione PRE/POST/Stampa #}
                            {% if trasferta.stato_pre_missione == 'In attesa' %}
                            <button type="button" class="btn btn-warning btn-sm mb-1" data-bs-toggle="modal"
                                    data-bs-target="#approvazioneModal" data-trasferta-id="{{ trasferta.id }}" data-fase="pre">
                                    Dettagli & Approv. Pre
                            </button>
                            {% elif trasferta.stato_post_missione == 'In attesa' %}
                            <button type="button" class="btn btn-warning btn-sm mb-1" data-bs-toggle="modal"
                                    data-bs-target="#approvazioneModal" data-trasferta-id="{{ trasferta.id }}" data-fase="post">
                                    Dettagli & Approv. Post
                            </button>
                            {% elif trasferta.stato_post_missione in ['Da rimborsare', 'Rimborso Concesso', 'Rimborso negato'] %}
                            <a href="{{ url_for('report_trasferta', trasferta_id=trasferta.id) }}" class="btn btn-info btn-sm"
                                    target="_blank">Stampa Report</a>
                            {% else %}
                            Nessuna azione di approvazione in sospeso
                            {% endif %}

                        {% endif %} {# **<-- QUESTO CHIUDE IL BLOCCO PRIORITÀ 1 (IF/ELSE)** #}

                    {# 2. AZIONI DIPENDENTE NORMALE (Se è il richiedente, ma NON è l'approvatore di questa missione) #}
                    {% elif trasferta.id_dipendente == current_user.id %}

                        {# Rendiconta #}
                        {% if trasferta.stato_pre_missione == 'Approvata' and trasferta.stato_post_missione == 'N/A' %}
                                <a href="{{ url_for('rendiconta_trasferta', trasferta_id=trasferta.id) }}"
                                class="btn btn-primary btn-sm">Rendiconta</a>

                        {# Pulsante Stampa Report per il Richiedente #}
                        {% elif trasferta.stato_post_missione in ['Da rimborsare', 'Rimborso Concesso', 'Rimborso negato'] %}
                                <a href="{{ url_for('report_trasferta', trasferta_id=trasferta.id) }}" class="btn btn-info btn-sm"
                                target="_blank">Stampa Report</a>

                        {% else %}
                            Nessuna azione in sospeso
                        {% endif %}

                    {# 3. ALTRI UTENTI #}
                    {% else %}
                        Nessuna azione
                    {% endif %} {# CHIUDE L'INTERO BLOCCO IF/ELIF/ELSE PRINCIPALE #}
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info mt-4" role="alert">
        Non hai trasferte richieste o richieste di approvazione pendenti.
    </div>
    {% endif %}

    <div class="mt-4">
        <a href="{{ url_for('nuova_trasferta') }}" class="btn btn-primary">Richiedi Nuova Trasferta</a>
    </div>

</div>

{# ====================================================================== #}
{# MODALE BOOTSTRAP PER DETTAGLIO E CONFERMA APPROVAZIONE #}
{# ====================================================================== #}
<div class="modal fade" id="approvazioneModal" tabindex="-1" aria-labelledby="approvazioneModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approvazioneModalLabel">Conferma Dettagli Trasferta</h5>
                {# Usa la classe corretta per chiudere, es. "btn-close" per Bootstrap 5 #}
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="dettagliTrasferta">Caricamento in corso...</div>
            </div>
            <div class="modal-footer" id="modalFooterAzioni">
            </div>
        </div>
    </div>
</div>


{# ====================================================================== #}
{# SCRIPT JAVASCRIPT PER GESTIRE IL MODALE #}
{# ====================================================================== #}
<script>
    // Assumiamo che la variabile globale 'approvazioneModal' sia definita se si usa Bootstrap.js
    var approvazioneModal = document.getElementById('approvazioneModal');

    if (approvazioneModal) {
        approvazioneModal.addEventListener('show.bs.modal', function (event) {
            // Ottieni i dati dal bottone che ha attivato il modale
            var button = event.relatedTarget;
            var trasfertaId = button.getAttribute('data-trasferta-id');
            var fase = button.getAttribute('data-fase');

            var dettagliDiv = document.getElementById('dettagliTrasferta');
            var footerDiv = document.getElementById('modalFooterAzioni');

            // 1. Caricamento dei dettagli della missione (contenuto del modale)
            dettagliDiv.innerHTML = 'Caricamento in corso...';

            // Richiama la rotta del backend per ottenere il frammento HTML
            fetch(`/get_dettagli_trasferta/${trasfertaId}`)
                .then(response => response.text())
                .then(html => {
                    dettagliDiv.innerHTML = html;
                })
                .catch(error => {
                    dettagliDiv.innerHTML = 'Errore nel caricamento dei dettagli. Controlla la console del browser.';
                    console.error('Errore Fetch Dettagli:', error);
                });


            // 2. Aggiornamento dinamico dei pulsanti di Approva/Rifiuta nel footer
            // ...
            if (fase === 'pre') {

                // Generiamo i form POST corretti invece dei link <a>
                var approvaUrl = "{{ url_for('approva_trasferta', trasferta_id=0) }}".replace('0', trasfertaId);
                var rifiutaUrl = "{{ url_for('rifiuta_trasferta', trasferta_id=0) }}".replace('0', trasfertaId);

                footerDiv.innerHTML = `
                    <form method="POST" action="${approvaUrl}" style="display: inline;">
                        <button type="submit" class="btn btn-success">
                            APPROVA PRE-MISSIONE
                        </button>
                    </form>
                    
                    <form method="POST" action="${rifiutaUrl}" style="display: inline;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Sei sicuro di voler RIFIUTARE questa missione?');">
                            RIFIUTA PRE-MISSIONE
                        </button>
                    </form>
                `;

                document.getElementById('approvazioneModalLabel').textContent = 'Conferma Richiesta Missione';

            } else if (fase === 'post') {
                // Generiamo gli URL Flask (POST)
                var approvaRimborsoUrl = "{{ url_for('approva_rimborso', trasferta_id=0) }}".replace('0', trasfertaId);
                var rifiutaRimborsoUrl = "{{ url_for('rifiuta_rimborso', trasferta_id=0) }}".replace('0', trasfertaId);

                // Inseriamo i form POST nel footer
                footerDiv.innerHTML = `
                    <form method="POST" action="${approvaRimborsoUrl}" style="display: inline;">
                        <button type="submit" class="btn btn-success">
                            APPROVA RIMBORSO (POST)
                        </button>
                    </form>
                    
                    <form method="POST" action="${rifiutaRimborsoUrl}" style="display: inline;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Sei sicuro di voler RIFIUTARE il rimborso?');">
                            RIFIUTA RIMBORSO (POST)
                        </button>
                    </form>
                `;
                document.getElementById('approvazioneModalLabel').textContent = 'Conferma Rendicontazione e Rimborso';
            }

        });
    }
</script>

{% endblock %}