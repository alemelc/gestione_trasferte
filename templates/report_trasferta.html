{% extends "base.html" %}

{% block title %}Report Missione #{{ trasferta.id }}{% endblock %}

{% block content %}
<div class="container mt-4 mb-5 printable-area">

    <div class="row justify-content-center">
        <div class="col-lg-10">

            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">REPORT COMPLETO DI MISSIONE E RENDICONTO</h4>
                    <p class="mb-0">ID Missione: <strong>{{ trasferta.id }}</strong></p>
                </div>
                <div class="card-body">

                    <h5 class="mt-3 mb-3 text-primary border-bottom pb-1">Dati Missione & Stato</h5>
                    <table class="table table-bordered table-sm">
                        <tbody>
                            <tr>
                                <td style="width: 30%;"><strong>Richiedente:</strong></td>
                                <td>{{ trasferta.richiedente.nome }} {{ trasferta.richiedente.cognome }}</td>
                            </tr>
                            <tr>
                                <td><strong>Data Missione:</strong></td>
                                <td>{{ trasferta.giorno_missione.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            <tr>
                                <td><strong>Destinazione (Presso):</strong></td>
                                <td>{{ trasferta.missione_presso }}</td>
                            </tr>
                            <tr>
                                <td><strong>Motivazione:</strong></td>
                                <td>{{ trasferta.motivo_missione or 'N/D' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Stato Pre-Missione:</strong></td>
                                <td><span
                                        class="badge bg-{{ 'success' if trasferta.stato_pre_missione == 'Approvata' else 'danger' if trasferta.stato_pre_missione == 'Rifiutata' else 'warning' }}">{{
                                        trasferta.stato_pre_missione }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Ora Inizio Prevista:</strong></td>
                                <td>{{ trasferta.inizio_missione_ora.strftime('%H:%M') if trasferta.inizio_missione_ora
                                    else 'N/D' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Mezzo Previsto:</strong></td>
                                <td>{{ trasferta.utilizzo_mezzo }}</td>
                            </tr>
                            <tr>
                                <td><strong>Aut. Extra Orario (Pre):</strong></td>
                                <td>{{ trasferta.aut_extra_orario }}</td>
                            </tr>
                            {% if trasferta.aut_timbratura_entrata or trasferta.aut_timbratura_uscita %}
                            <tr>
                                <td><strong>Timbrature Autorizzate:</strong></td>
                                <td>
                                    {% if trasferta.aut_timbratura_entrata %}Entrata: {{
                                    trasferta.aut_timbratura_entrata.strftime('%H:%M') }}<br>{% endif %}
                                    {% if trasferta.aut_timbratura_uscita %}Uscita: {{
                                    trasferta.aut_timbratura_uscita.strftime('%H:%M') }}<br>{% endif %}
                                    (Motivo: {{ trasferta.motivo_timbratura or '-' }})
                                </td>
                            </tr>
                            {% endif %}
                            {% if trasferta.note_premissione %}
                            <tr>
                                <td><strong>Note Pre-Missione:</strong></td>
                                <td>{{ trasferta.note_premissione }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td><strong>Approvato Pre da:</strong></td>
                                <td>{{ trasferta.approvatore_pre.nome }} {{ trasferta.approvatore_pre.cognome }} (ID: {{
                                    trasferta.id_approvatore_pre or 'N/D' }})
                                    {% if trasferta.data_approvazione_pre %}
                                    <br><small class="text-muted">il {{
                                        trasferta.data_approvazione_pre.strftime('%d/%m/%Y alle %H:%M') }}</small>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <h5 class="mt-4 mb-3 text-primary border-bottom pb-1">Dettagli di Rendicontazione</h5>

                    {% if trasferta.stato_post_missione != 'N/A' %}
                    <table class="table table-bordered table-sm">
                        <tr>
                            <td style="width: 30%;"><strong>Orario Effettivo Missione:</strong></td>
                            <td>
                                {% if trasferta.ora_inizio_effettiva and trasferta.ora_fine_effettiva %}
                                Dalle {{ trasferta.ora_inizio_effettiva.strftime('%H:%M') }} alle {{
                                trasferta.ora_fine_effettiva.strftime('%H:%M') }} (Durata: {{
                                trasferta.durata_totale_ore or 'N/D' }} ore)
                                {% else %}
                                N/D
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Pernotto:</strong></td>
                            <td>{{ 'Sì' if trasferta.pernotto else 'No' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Durata Viaggio A/R (min):</strong></td>
                            <td>
                                Andata: {{ trasferta.durata_viaggio_andata_min or 'N/D' }} min |
                                Ritorno: {{ trasferta.durata_viaggio_ritorno_min or 'N/D' }} min
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Chilometri Percorsi (Km):</strong></td>
                            <td>{{ trasferta.km_percorsi or 'N/D' }} Km</td>
                        </tr>
                        <tr>
                            <td><strong>Mezzo Utilizzato:</strong></td>
                            <td>{{ trasferta.mezzo_km_percorsi or 'N/D' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Percorso Effettuato:</strong></td>
                            <td>{{ trasferta.percorso_effettuato or 'Non specificato' }}</td>
                        </tr>

                        <tr>
                            <td><strong>Gestione Pausa Pranzo:</strong></td>
                            <td>{{ trasferta.richiesta_pausa_pranzo or 'N/D' }}</td>
                        </tr>
                        {% if trasferta.pausa_pranzo_dalle and trasferta.pausa_pranzo_alle %}
                        <tr>
                            <td><strong>Orario Pausa Pranzo:</strong></td>
                            <td>Dalle {{ trasferta.pausa_pranzo_dalle.strftime('%H:%M') }} alle {{
                                trasferta.pausa_pranzo_alle.strftime('%H:%M') }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td><strong>Gestione Extra Orario:</strong></td>
                            <td>{{ trasferta.extra_orario or 'N/D' }}</td>
                        </tr>
                        {% if trasferta.note_rendicontazione %}
                        <tr>
                            <th>**Rapporto Finale / Note**</th>
                            <td>{{ trasferta.note_rendicontazione | replace('\n', '<br>') | safe }}</td>
                        </tr>
                        {% endif %}

                    </table>
                    <!--
                    {% else %}
                        <div class="alert alert-warning">Il rendiconto post-missione non è ancora stato compilato.</div>
                    {% endif %}
                    -->

                    <h5 class="mt-4 mb-3 text-primary border-bottom pb-1">Elenco Spese Sostenute</h5>
                    {% if trasferta.spese|length > 0 %}
                    <table class="table table-striped table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Data</th>
                                <th>Categoria</th>
                                <th>Descrizione</th>
                                <th class="text-end" style="width: 15%;">Importo (€)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for spesa in trasferta.spese %}
                            <tr>
                                <td>{{ spesa.data_spesa.strftime('%d/%m/%Y') }}</td>
                                <td>{{ spesa.categoria }}</td>
                                <td>{{ spesa.descrizione or '-' }}</td>
                                <td class="text-end">{{ "%.2f"|format(spesa.importo) }} €</td>
                            </tr>
                            {% endfor %}
                            <tr class="table-warning">
                                <td colspan="3" class="text-end"><strong>TOTALE SPESE</strong></td>
                                <td class="text-end"><strong>{{ "%.2f"|format(trasferta.spese|sum(attribute='importo'))
                                        }} €</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-light border">Nessuna spesa registrata per questa missione.</div>
                    {% endif %}
                    <h5 class="mt-4 mb-3 text-primary border-bottom pb-1">Approvazione Post-Missione</h5>
                    <table class="table table-bordered table-sm">
                        <tbody>
                            <tr>
                                <td style="width: 30%;"><strong>Stato Finale:</strong></td>
                                <td><span
                                        class="badge bg-{{ 'success' if trasferta.stato_post_missione in ['Da rimborsare', 'Rimborso Concesso'] else 'danger' if trasferta.stato_post_missione == 'Rimborso negato' else 'info' }}">{{
                                        trasferta.stato_post_missione }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Approvato da:</strong></td>
                                <td>{{ trasferta.approvatore_post.nome }} {{ trasferta.approvatore_post.cognome }} (ID:
                                    {{ trasferta.id_approvatore_post or 'N/D' }})</td>
                            </tr>

                            <tr>
                                <td><strong>Data Approvazione:</strong></td>
                                <td>{{ trasferta.data_approvazione_post.strftime('%d/%m/%Y %H:%M') }}</td>
                            </tr>

                        </tbody>
                    </table>

                    <div class="mt-4 text-center">
                        <button class="btn btn-secondary btn-lg d-print-none" onclick="window.print()">Stampa
                            Report</button>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block custom_scripts %}
<style>
    /* Nasconde la barra di navigazione e altri elementi non stampabili */
    @media print {
        @page {
            size: A4;
            margin: 10mm;
        }

        .navbar,
        .footer,
        .d-print-none,
        .alert,
        button {
            display: none !important;
        }

        body {
            background-color: #fff;
            font-size: 12px;
            /* Riduce leggermente il font per far stare tutto */
        }

        .printable-area {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .container,
        .container-fluid,
        .row,
        .col-lg-10 {
            width: 100% !important;
            max-width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            flex: 0 0 100% !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
        }

        .card-header {
            background-color: #f8f9fa !important;
            /* Grigio chiaro invece di blu per risparmiare inchiostro */
            color: #000 !important;
            border-bottom: 2px solid #000 !important;
        }

        .card-body {
            padding: 0 !important;
        }

        /* Gestione tabelle */
        table {
            page-break-inside: auto;
            width: 100% !important;
        }

        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        /* Assicura che i badge siano leggibili in BN */
        .badge {
            border: 1px solid #000;
            color: #000 !important;
            background-color: transparent !important;
        }
    }
</style>
{% endblock %}